#!/usr/bin/env node
// scripts/generate-svg-registry.js
// 
// Este script genera automáticamente el archivo de registro de SVGs
// Escanea la carpeta assets/kanjivg/ y crea los imports necesarios
//
// Uso: node scripts/generate-svg-registry.js

const fs = require('fs');
const path = require('path');

const KANJIVG_DIR = path.join(__dirname, '..', 'assets', 'kanjivg');
const OUTPUT_FILE = path.join(__dirname, '..', 'src', 'data', 'svgRegistry.ts');
const KVG_INDEX_PATH = path.join(__dirname, '..', 'assets', 'kvg-index.json');

// Leer el índice de caracteres
const kvgIndex = JSON.parse(fs.readFileSync(KVG_INDEX_PATH, 'utf8'));

// Obtener todos los archivos SVG necesarios del índice
const neededFiles = new Set();
Object.values(kvgIndex).forEach(files => {
  if (Array.isArray(files) && files.length > 0) {
    neededFiles.add(files[0]);
  }
});

console.log(`Found ${neededFiles.size} SVG files referenced in kvg-index.json`);

// Verificar cuáles existen en el directorio
const existingFiles = [];
const missingFiles = [];

neededFiles.forEach(filename => {
  const filepath = path.join(KANJIVG_DIR, filename);
  if (fs.existsSync(filepath)) {
    existingFiles.push(filename);
  } else {
    missingFiles.push(filename);
  }
});

console.log(`Existing: ${existingFiles.length}, Missing: ${missingFiles.length}`);

if (missingFiles.length > 0) {
  console.log('\nMissing files (first 10):');
  missingFiles.slice(0, 10).forEach(f => console.log(`  - ${f}`));
}

// Generar el archivo de registro
const imports = existingFiles.map((filename, index) => {
  const varName = `svg_${filename.replace('.svg', '').replace(/-/g, '_')}`;
  return `import ${varName} from '../../assets/kanjivg/${filename}';`;
}).join('\n');

const registryEntries = existingFiles.map(filename => {
  const varName = `svg_${filename.replace('.svg', '').replace(/-/g, '_')}`;
  return `  '${filename}': ${varName},`;
}).join('\n');

const outputContent = `// src/data/svgRegistry.ts
// AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
// Generated by: node scripts/generate-svg-registry.js
// Total SVGs: ${existingFiles.length}

${imports}

export const SVG_REGISTRY: Record<string, string> = {
${registryEntries}
};

export default SVG_REGISTRY;
`;

// Crear directorio si no existe
const outputDir = path.dirname(OUTPUT_FILE);
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

// Escribir archivo
fs.writeFileSync(OUTPUT_FILE, outputContent);

console.log(`\nGenerated: ${OUTPUT_FILE}`);
console.log(`Total SVGs registered: ${existingFiles.length}`);